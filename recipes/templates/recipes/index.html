{% extends 'recipes/base.html' %}
{% load static %}

{% block content %}
<!-- üçΩÔ∏è Hero Section -->
<div class="p-5 mb-4 rounded-3" style="background-color: rgba(255,255,255,0.85); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
  <div class="container py-3">
    <h1 class="display-5 fw-bold" style="color: #d76a03;">Welcome to Shared Spoon üç¥</h1>
    <p class="col-md-8 fs-5" style="color: #333;">
      Discover, save, and share your favorite recipes in one cozy place.
    </p>
    {% if user.is_authenticated and user_recipes_count == 0 %}
      <a href="{% url 'recipes:add' %}" class="btn btn-warning btn-lg mt-2">Add Your First Recipe</a>
    {% endif %}
  </div>
</div>

<h2 class="mt-5">Latest Recipes</h2>

<!-- üîç Filter Form -->
<form method="get" class="row g-3 align-items-center mb-4">
  <div class="col-sm-6">
    <input type="text" name="q" class="form-control" placeholder="Search recipes..." value="{{ query|default:'' }}">
  </div>
  <div class="col-sm-4">
    <select name="category" class="form-select">
      <option value="all" {% if selected_category == "all" or not selected_category %}selected{% endif %}>All Categories</option>
      <option value="breakfast" {% if selected_category == "breakfast" %}selected{% endif %}>Breakfast</option>
      <option value="lunch" {% if selected_category == "lunch" %}selected{% endif %}>Lunch</option>
      <option value="dinner" {% if selected_category == "dinner" %}selected{% endif %}>Dinner</option>
      <option value="dessert" {% if selected_category == "dessert" %}selected{% endif %}>Dessert</option>
      <option value="vegan" {% if selected_category == "vegan" %}selected{% endif %}>Vegan</option>
      <option value="snack" {% if selected_category == "snack" %}selected{% endif %}>Snack</option>
    </select>
  </div>
  <div class="col-sm-2">
    <button type="submit" class="btn btn-primary w-100">Search</button>
  </div>
</form>

<!-- ‚≠ê Recipe Grid -->
<div class="recipe-grid">
  {% for recipe in page_obj %}
    <div class="recipe-card">
      <!-- üë§ Author Info -->
      <div class="d-flex align-items-center mb-2">
        {% if recipe.user.profile.avatar %}
          <img src="{{ recipe.user.profile.avatar.url }}" alt="{{ recipe.user.username }}'s avatar" class="rounded-circle me-2" width="32" height="32" style="object-fit: cover;">
        {% else %}
          <img src="{% static 'recipes/img/default-avatar.png' %}" alt="Default avatar" class="rounded-circle me-2" width="32" height="32" style="object-fit: cover;">
        {% endif %}
        <small class="text-muted">
            Posted by 
            <a href="{% url 'recipes:public_profile' recipe.user.username %}">
              <strong>{{ recipe.user.username }}</strong>
            </a>
          </small>
      </div>

      {% if recipe.image %}
        <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="img-fluid rounded mb-2">
      {% else %}
        <img src="{% static 'recipes/img/default-recipe.jpg' %}" alt="Default recipe image" class="img-fluid rounded mb-2">
      {% endif %}

      <h3>{{ recipe.title }}</h3>

      <p><strong>üçΩÔ∏è Category:</strong>
        {% if recipe.category == "breakfast" %} ü•û Breakfast
        {% elif recipe.category == "lunch" %} ü•™ Lunch
        {% elif recipe.category == "dinner" %} üçù Dinner
        {% elif recipe.category == "dessert" %} üç∞ Dessert
        {% elif recipe.category == "vegan" %} ü•ó Vegan
        {% elif recipe.category == "snack" %} üç™ Snack
        {% else %} {{ recipe.category|capfirst }}
        {% endif %}
      </p>

      <p>{{ recipe.description|truncatechars:200 }} 
        <a href="{% url 'recipes:recipe_detail' recipe.id %}">Read More ‚Üí</a>
      </p>

      {% if user.is_authenticated %}
      <form method="POST" action="{% url 'recipes:toggle_favorite' recipe.id %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm {% if user in recipe.liked_by.all %}btn-danger{% else %}btn-outline-danger{% endif %}">
          ‚ù§Ô∏è {% if user in recipe.liked_by.all %} Unsave {% else %} Save {% endif %}
        </button>
      </form>
      {% else %}
        <small><a href="{% url 'login' %}">Login to save ‚ù§Ô∏è</a></small>
      {% endif %}

      <p>‚ù§Ô∏è Saved by {{ recipe.liked_by.count }} user{{ recipe.liked_by.count|pluralize }}</p>

      <!-- ‚≠ê Average Rating -->
      <p><strong>Average Rating:</strong>
        {% if recipe.avg_rating %}
          <span id="rating-display-{{ recipe.id }}">{{ recipe.avg_rating|floatformat:1 }} ‚≠ê</span>
        {% else %}
          No ratings yet.
        {% endif %}
      </p>

      <!-- ‚≠ê User Rating Form (AJAX) -->
      {% if user.is_authenticated %}
<div class="rating-container" data-recipe-id="{{ recipe.id }}">
  <form class="rating-form">
    {% csrf_token %}
    <div class="d-flex align-items-center gap-2">

      {% if recipe.user_rating %}
        <div class="d-flex align-items-center gap-2">
          <strong class="mb-0">Your rating: {{ recipe.user_rating.value }} ‚≠ê</strong>
          <button type="button" class="btn btn-sm btn-outline-primary submit-rating-btn">
            ‚úèÔ∏è Edit your rating
          </button>
        </div>
        <!-- Hidden select to update rating -->
        <div class="edit-rating-select mt-2" style="display: none;">
          <select name="rating" id="rating-{{ recipe.id }}" class="form-select w-auto">
            <option value="">Select rating</option>
            {% for i in "54321" %}
              <option value="{{ i }}" {% if recipe.user_rating and recipe.user_rating.value == i|add:"0" %}selected{% endif %}>{{ i }} ‚≠ê</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-sm btn-success submit-rating-btn">
            Save
          </button>
        </div>
      {% else %}
        <select name="rating" id="rating-{{ recipe.id }}" class="form-select w-auto">
          <option value="">Select rating</option>
          {% for i in "54321" %}
            <option value="{{ i }}" {% if recipe.user_rating and recipe.user_rating.value == i|add:"0" %}selected{% endif %}>{{ i }} ‚≠ê</option>
          {% endfor %}
        </select>
        <button type="button" class="btn btn-sm btn-success submit-rating-btn">
          Rate
        </button>
      {% endif %}

    </div>
    <div class="rating-feedback mt-1"></div>
  </form>
</div>
{% else %}
<p><em><a href="{% url 'login' %}">Log in</a> to rate this recipe.</em></p>
{% endif %}
    </div>
  {% empty %}
    <p class="alert alert-info text-center">No recipes yet! Be the first to add a recipe!</p>
  {% endfor %}
</div>

<!-- üìÑ Pagination -->
{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
  <ul class="pagination justify-content-center flex-wrap">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">&laquo; First</a>
      </li>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
          <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">{{ num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">Last &raquo;</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('JavaScript loaded');
    });
    
    document.addEventListener('click', async function(event) {
        if (event.target && event.target.classList.contains('submit-rating-btn')) {
            const button = event.target;
            const container = button.closest('.rating-container');
            const form = button.closest('form');
            const recipeId = container.dataset.recipeId;
            const editSection = container.querySelector('.edit-rating-select');
    
            // üî• If button says "Edit your rating"
            if (button.innerText.includes('Edit')) {
                if (editSection) {
                    editSection.style.display = 'flex'; // Show the hidden select box
                }
                button.style.display = 'none'; // Hide "Edit your rating" button
                return; // Stop here ‚Äî do not submit yet
            }
    
            // üî• Otherwise, submitting the new rating
            const ratingSelect = form.querySelector('select[name="rating"]');
            const rating = ratingSelect.value;
            const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const feedbackDiv = container.querySelector('.rating-feedback');
    
            if (!rating) {
                feedbackDiv.innerHTML = '<div class="alert alert-warning p-2">Please select a rating first!</div>';
                return;
            }
    
            button.disabled = true;
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
            try {
                const response = await fetch(`/rate-recipe/${recipeId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    },
                    body: `rating=${rating}`
                });
    
                const data = await response.json();
    
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to submit rating');
                }
    
                Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: 'Thank you! üéâ',
                    text: 'Your updated rating has been submitted.',
                    showConfirmButton: true,
                    confirmButtonText: 'OK',
                    width: '300px',
                    padding: '1em',
                    timer: 3000,
                    timerProgressBar: true
                });
    
                // After successful update, hide select again
                if (editSection) {
                    editSection.style.display = 'none';
                }
    
                // Show back the Edit button
                const editButton = container.querySelector('.submit-rating-btn');
                if (editButton) {
                    editButton.style.display = 'inline-block';
                    editButton.textContent = 'Edit your rating';
                }
    
                // Update rating text
                const ratingDisplay = document.getElementById(`rating-display-${recipeId}`);
                if (ratingDisplay && typeof data.avg_rating === 'number') {
                    ratingDisplay.textContent = `${data.avg_rating.toFixed(1)} ‚≠ê`;
                }
    
            } catch (error) {
                console.error('Rating error:', error);
                feedbackDiv.innerHTML = `<div class="alert alert-danger p-2">Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
    });
    </script>
    {% endblock %}